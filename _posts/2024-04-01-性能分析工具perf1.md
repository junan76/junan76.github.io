---
layout: post
title: 性能分析工具:perf(1)
categories: 性能分析
tags: 性能 perf
---

`perf`是`linux`内核提供的一个性能分析工具, 在`linux`的源码中包含了其代码实现. `perf`工具利用一些软件或者硬件的事件对程序的性能进行评估. 这里通过一个缓存失效的例子, 简单介绍如何使用`perf`去定位程序的性能瓶颈.

## 0x01 安装`perf`

`perf`的使用和当前的内核版本是有关联的, 当你的内核版本有一些比较大的更新, 就可能需要安装对应版本的`perf`. 对于`ubuntu`系统, 可以安装软件包:

```shell
$ sudo apt install linux-tools-generic
```

安装完成之后, 执行`"perf list"`可以查看`perf`工具支持的事件类型, 此时可能会提示没有找到当前版本的内核对应的`perf`, 比如:

```shell
$ perf list
WARNING: perf not found for kernel 6.5.0-26

  You may need to install the following packages for this specific kernel:
    linux-tools-6.5.0-26-generic
    linux-cloud-tools-6.5.0-26-generic

  You may also want to install one of the following packages to keep up to date:
    linux-tools-generic
    linux-cloud-tools-generic
```
如果出现类似警告, 按照提示安装对应的软件包就可以解决.

## 0x02 配置`perf`

默认情况下, 普通用户使用`perf`工具, 能使用的功能是受限的, 可以通过修改内核的参数配置, 让非`root`用户也可以正常使用`perf`, 修改之后的配置如下:

```shell
$ sysctl kernel.perf_event_paranoid 
kernel.perf_event_paranoid = -1
$ sysctl kernel.kptr_restrict 
kernel.kptr_restrict = 0
```

关于`perf_event_paranoid`参数的含义如下:

![alt text](<../assets/img/posts/2024-04-01-性能分析工具perf1/1.png>)

简单来说, 这个参数可以控制非特权用户能够如何使用`perf`工具, 其中`-1`表示几乎全部的`perf_event`对所有用户都可用, 可以根据自己系统的实际情况进行配置, 从文档中可以看出, 用户的`CAP_PERFMON`权能也会影响`perf`工具的使用. 关于其他的内核参数配置, 可以参考`linux`的[官方文档](https://docs.kernel.org/admin-guide/sysctl/kernel.html), 这里可以找到`"/proc/sys/kernel"`目录下其他参数的具体含义.

## 0x03 分析缓存失效问题

## 0x04 总结